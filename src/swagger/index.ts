import * as fs from 'fs';
import { ParsedTest } from '../types';
import { manipulateSwagger } from './helpers';
import { SwaggerDocs300 } from './index.types';

const defaultConfig = {
  info: {
    version: '1.0.0',
    title: 'test-driven-documentation',
    description:
      'API docs generated by test-driven-documentation',
    termsOfService: 'https://github.com/gutioliveira/test-driven-documentation',
    contact: {
      name: 'test-driven-documentation',
      email: 'test-driven-documentation@test-driven-documentation.com',
      url: 'http://test-driven-documentation.com',
    },
    license: {
      name: 'MIT',
      url: 'https://opensource.org/license/mit/',
    },
  },
  servers: [
    {
      url: 'http://localhost:3000',
    },
  ],
}

export const generateSwaggerDocs300 = (path: string, config?: SwaggerDocs300): string => {
  const info = fs.readFileSync(path, 'utf8');
  const docs = JSON.parse(info);
  const swagger: any = {
    openapi: '3.0.0',
    ...defaultConfig,
    paths: {},
    ...config
  };
  docs.forEach((doc: ParsedTest) => {
    manipulateSwagger(swagger, doc);
  });
  fs.writeFileSync(path, JSON.stringify(swagger));
  return JSON.stringify(swagger);
};